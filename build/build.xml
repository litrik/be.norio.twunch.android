<?xml version="1.0" encoding="UTF-8"?>
<project name="be.norio.twunch.android" default="all" basedir="..">

	<target name="clean" description="Clean">
		<delete dir="work" />
		<delete dir="dist" />
	</target>

	<macrodef name="build.android">
		<attribute name="env" />
		<sequential>
			<mkdir dir="work/@{env}" />
			<ant antfile="${basedir}/build/android.xml" target="build-release" inheritall="false" inheritrefs="false" dir="work/@{env}">
				<property name="root" value="${basedir}" />
				<property name="env" value="@{env}" />
				<property file="${basedir}/build/properties/@{env}.properties" />
			</ant>
		</sequential>
	</macrodef>

	<macrodef name="uninstall">
		<attribute name="package" />
		<sequential>
			<echo message="Uninstalling @{package}..." />
			<exec executable="adb">
				<arg value="uninstall" />
				<arg value="@{package}" />
			</exec>
		</sequential>
	</macrodef>

	<target name="all" description="Builds all">
		<build.android env="dev" />
		<build.android env="prd" />
	</target>

	<target name="uninstall" description="Uninstall all APKs">
		<uninstall package="be.norio.twunch.android" />
	</target>

	<target name="eclipse" description="Build eclipse env">
		<ant antfile="${basedir}/build/android.xml" target="generate-build-properties" inheritall="false" inheritrefs="false" dir="${basedir}">
			<property name="root" value="${basedir}" />
			<property file="${basedir}/build/properties/dev.properties" />
		</ant>
	</target>

	<macrodef name="generate-ext-project">
		<attribute name="project" />
		<attribute name="zip" />
		<sequential>
			<echo message="Generating project @{project} from @{zip}" />
			<mkdir dir="../@{project}"/>
			<unzip dest="../@{project}">
				<fileset dir="ext">
					<include name="@{zip}" />
				</fileset>
				<patternset>
					<include name="*/library/src/**" />
					<include name="*/library/res/**" />
					<include name="*/library/libs/**" />
					<include name="*/library/AndroidManifest.xml" />
					<include name="*/library/project.properties" />
				</patternset>
				<cutdirsmapper dirs="2" />
			</unzip>
			<copy todir="../@{project}/libs" file="libs/android-support-v4.jar" />
			<copy todir="../@{project}">
				<fileset dir="ext">
					<include name=".project" />
					<include name=".classpath" />
				</fileset>
			    <filterset>
			      <filter token="PROJECT" value="@{project}"/>
			    </filterset>
			</copy>
		</sequential>
	</macrodef>

	<target name="ext-projects" description="Extract all external dependencies for use in Eclipse">
		<generate-ext-project project="ActionBarSherlock" zip="JakeWharton-ActionBarSherlock-*.zip" />
		<generate-ext-project project="android-mapviewballoons" zip="jgilfelt-android-mapviewballoons-stable-*.zip" />
	</target>

</project>
